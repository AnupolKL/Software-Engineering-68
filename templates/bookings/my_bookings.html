{% extends "base.html" %}
{% block title %}การจองของฉัน | CUTCAMP{% endblock %}

{% block content %}
<section class="max-w-5xl mx-auto p-6 space-y-6 bg-[#2a3731] rounded-xl">

  <h1 class="text-2xl font-bold mb-2 text-white bg-[#212c27] max-w-5xl mx-auto p-6 rounded-xl text-center">
    การจองของฉัน
  </h1>

  <p class="text-gray-300 text-md">คิวและประวัติการจองของฉัน</p>
  <p class="text-gray-400 text-sm">
    หมายเหตุ : สามารถแก้ไข/ยกเลิกได้เฉพาะก่อนวันนัดเท่านั้น
  </p>

  {# ฟอร์มกรองตามเดือน #}
  <form method="get" class="flex flex-wrap items-center gap-3 mt-2">
    <label for="month" class="text-sm text-gray-200">
      กรองตามเดือน :
    </label>
    <input
      type="month"
      id="month"
      name="month"
      value="{{ selected_month }}"
      class="rounded-lg px-2 py-1 text-sm text-black bg-white border border-gray-300"
    >
    <button
      type="submit"
      class="text-xs px-3 py-1 bg-white/10 hover:bg-white/20 text-gray-100 rounded-lg border border-white/20"
    >
      กรอง
    </button>

    {% if selected_month %}
      <a
        href="{% url 'my_bookings' %}"
        class="text-xs text-gray-300 underline ml-2"
      >
        ล้างตัวกรอง
      </a>
    {% endif %}
  </form>

  {% if bookings %}
    <div class="space-y-4 mt-6">

      {% for b in bookings %}
        <div class="bg-white rounded-xl p-4 shadow border flex flex-col md:flex-row md:items-center md:justify-between gap-4">

          <!-- ซ้าย: ข้อมูลหลัก -->
          <div class="flex-1 space-y-1">

            <!-- วันที่ และเวลา -->
            <div class="text-sm text-gray-700">
              <span class="font-semibold">วันที่ / เวลา:</span>
              {{ b.start_at|date:"Y-m-d H:i" }}
            </div>

            <!-- บริการ -->
            <div class="text-sm text-gray-700">
              <span class="font-semibold">บริการ:</span>
              {{ b.service.name }}
            </div>

            <!-- ช่าง -->
            <div class="text-sm text-gray-700">
              <span class="font-semibold">ช่าง:</span>
              {% if b.barber %}
                {{ b.barber.username }}
              {% else %}
                -
              {% endif %}
            </div>

            <!-- ชนิด (walk-in / online) -->
            <div class="text-sm text-gray-700">
              <span class="font-semibold">ชนิด:</span>
              {% if b.source %}
                {{ b.get_source_display }}
              {% else %}
                -
              {% endif %}
            </div>

          </div>

          <!-- ขวา: สถานะ & ปุ่ม -->
          <div class="flex flex-col items-start md:items-end gap-2">

            <!-- สถานะ -->
            <div class="text-sm">
              {% if b.status == "pending" %}
                <span class="px-3 py-1 rounded-full bg-yellow-100 text-yellow-700 text-xs font-medium">
                  รอการยืนยัน
                </span>

              {% elif b.status == "confirmed" %}
                <span class="px-3 py-1 rounded-full bg-blue-100 text-blue-700 text-xs font-medium">
                  ยืนยันแล้ว
                </span>

              {% elif b.status == "completed" %}
                <span class="px-3 py-1 rounded-full bg-emerald-100 text-emerald-700 text-xs font-medium">
                  เสร็จสิ้น
                </span>

              {% elif b.status == "canceled" %}
                <span class="px-3 py-1 rounded-full bg-red-100 text-red-700 text-xs font-medium">
                  ยกเลิกแล้ว
                </span>

              {% else %}
                <span class="px-3 py-1 rounded-full bg-gray-100 text-gray-600 text-xs font-medium">
                  -
                </span>
              {% endif %}
            </div>

            <!-- ปุ่มจัดการ -->
            <div class="flex flex-wrap gap-2">

              {% if b.status == "completed" %}
                {% if b.review %}
                  <span class="text-amber-500 text-xs font-medium">รีวิวแล้ว</span>
                {% else %}
                  <a href="{% url 'review_create_from_booking' b.id %}"
                    class="text-white bg-amber-600 hover:bg-amber-500 px-3 py-1 rounded-lg text-xs">
                    เขียนรีวิว
                  </a>
                {% endif %}

              {% elif b.status == "canceled" %}
                <span class="text-xs text-gray-400">ยกเลิกแล้ว</span>

              {% else %}

                {% if b.can_modify %}
                  <a href="{% url 'booking_edit' b.id %}"
                    class="text-white bg-blue-400 hover:bg-blue-300 px-3 py-1 rounded-lg text-xs">
                    แก้ไข
                  </a>

                  <form action="{% url 'booking_cancel' b.id %}" method="post" class="inline">
                    {% csrf_token %}
                    <button type="submit"
                      class="text-white bg-red-500 hover:bg-red-400 px-3 py-1 rounded-lg text-xs">
                      ยกเลิก
                    </button>
                  </form>
                {% else %}
                  <span class="text-xs text-gray-400">ไม่สามารถแก้ไขได้</span>
                {% endif %}

              {% endif %}
            </div>

          </div>

        </div>
      {% endfor %}

    </div>

  {% else %}
    <div class="mt-6 p-6 rounded-xl bg-white text-center text-gray-600">
      ยังไม่มีการจองในระบบ
    </div>
  {% endif %}

</section>
{% endblock %}
